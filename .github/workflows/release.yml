name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.0.0)'
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true
  DATABASE_URL: sqlite:data.db

jobs:
  # é¢„æ£€æŸ¥ - ç¡®ä¿ä»£ç è´¨é‡
  pre-check:
    name: Pre-release Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Check formatting
      run: cargo fmt -- --check
    
    - name: Run clippy
      run: cargo clippy -- -D warnings

  # æ„å»ºå„å¹³å°åŒ…
  build-tauri:
    needs: pre-check
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            target: 'universal-apple-darwin'
            args: '--target universal-apple-darwin'
            bundles: 'dmg'
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            args: ''
            bundles: 'deb,appimage'
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            args: ''
            bundles: 'msi,nsis'

    runs-on: ${{ matrix.platform }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown,${{ matrix.target }}
    
    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: |
          . -> target
          ./src-tauri -> target
        key: ${{ matrix.platform }}-release
    
    - name: Install dependencies (Ubuntu)
      if: matrix.platform == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.1-dev \
          build-essential \
          curl \
          wget \
          file \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev
    
    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build
    
    - name: Build plugins
      run: |
        for plugin in plugins/*/; do
          if [ -f "$plugin/Cargo.toml" ] || [ -f "$plugin\\Cargo.toml" ]; then
            echo "Building plugin: $(basename $plugin)"
            cd "$plugin"
            cargo build --target wasm32-unknown-unknown --release
            cd ../..
          fi
        done
      shell: bash
    
    - name: Build Tauri App
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      with:
        tagName: ${{ github.ref_name || format('v{0}', github.event.inputs.version) }}
        releaseName: 'Minimal Kernel ${{ github.ref_name || github.event.inputs.version }}'
        releaseBody: |
          ## ğŸ‰ Minimal Kernel ${{ github.ref_name || github.event.inputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½å®‰è£…
          - **macOS**: `.dmg` æ–‡ä»¶ (æ”¯æŒ Intel å’Œ Apple Silicon)
          - **Windows**: `.msi` æˆ– `.exe` å®‰è£…åŒ…
          - **Linux**: `.deb` (Ubuntu/Debian) æˆ– `.AppImage` (é€šç”¨)
          
          ### ğŸ” ç­¾åéªŒè¯
          æ‰€æœ‰å®‰è£…åŒ…å‡å·²ç­¾åï¼Œè¯·éªŒè¯ç­¾åä»¥ç¡®ä¿å®‰å…¨ã€‚
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—è¯·è®¿é—® [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. éªŒè¯ç­¾åï¼ˆå¯é€‰ä½†æ¨èï¼‰
          3. æŒ‰ç…§ç³»ç»Ÿæç¤ºå®Œæˆå®‰è£…
          4. å¯åŠ¨åº”ç”¨ï¼Œå¼€å§‹ä½¿ç”¨ï¼
          
          ---
          _æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}_
        releaseDraft: true
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        args: ${{ matrix.args }}
        includeDebug: false
        includeRelease: true
        includeUpdaterJson: true